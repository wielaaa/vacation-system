import streamlit as st
import pandas as pd
import mysql.connector
from datetime import datetime, timedelta
import hashlib
import time
import plotly.express as px

# ุฅุนุฏุงุฏุงุช ุงูุตูุญุฉ
st.set_page_config(
    page_title="ูุธุงู ุฅุฏุงุฑุฉ ุงูุฅุฌุงุฒุงุช - ุงููุทุงุฑ",
    page_icon="โ๏ธ",
    layout="wide",
    initial_sidebar_state="expanded"
)

# CSS ูุฎุตุต ููุนุฑุจูุฉ
st.markdown("""
<style>
    .main .block-container {
        direction: rtl;
        text-align: right;
    }
    .stButton button {
        width: 100%;
    }
    .success-msg {
        background-color: #d4edda;
        color: #155724;
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
    }
    .error-msg {
        background-color: #f8d7da;
        color: #721c24;
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
    }
    .info-box {
        background-color: #d1ecf1;
        border: 1px solid #bee5eb;
        border-radius: 5px;
        padding: 15px;
        margin: 10px 0;
    }
</style>
""", unsafe_allow_html=True)

# ูุธุงุฆู ูุงุนุฏุฉ ุงูุจูุงูุงุช
def ุงูุญุตูู_ุนูู_ุงูุงุชุตุงู():
    return mysql.connector.connect(
        host="localhost",
        user="root",
        password="",
        database="ูุธุงู_ุฅุฌุงุฒุงุช_ุงููุทุงุฑ",
        charset='utf8mb4'
    )

def ุชุดููุฑ_ูููุฉ_ุงููุฑูุฑ(ูููุฉ_ุงููุฑูุฑ):
    return hashlib.sha256(ูููุฉ_ุงููุฑูุฑ.encode()).hexdigest()

def ุชููุฆุฉ_ูุงุนุฏุฉ_ุงูุจูุงูุงุช():
    try:
        connection = ุงูุญุตูู_ุนูู_ุงูุงุชุตุงู()
        cursor = connection.cursor()
        
        # ุฅูุดุงุก ุงูุฌุฏุงูู
        ุฌุฏุงูู = [
            """
            CREATE TABLE IF NOT EXISTS ุงููุณุชุฎุฏููู (
                ูุนุฑู INT AUTO_INCREMENT PRIMARY KEY,
                ุงุณู_ุงููุณุชุฎุฏู VARCHAR(50) UNIQUE NOT NULL,
                ูููุฉ_ุงููุฑูุฑ VARCHAR(255) NOT NULL,
                ุงุณู_ุงูููุธู VARCHAR(100) NOT NULL,
                ููุน_ุงููุณุชุฎุฏู ENUM('ููุธู', 'ูุฏูุฑ', 'ูุณุคูู_ุฅุฏุงุฑู', 'ูุฏูุฑ_ุงููุธุงู') NOT NULL,
                ุงููุณู VARCHAR(100),
                ุงููุฏูุฑ_ุงููุจุงุดุฑ INT,
                ุงูุญุงูุฉ ENUM('ูุดุท', 'ุบูุฑ ูุดุท') DEFAULT 'ูุดุท',
                ุชุงุฑูุฎ_ุงูุฅูุดุงุก TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
            """,
            """
            CREATE TABLE IF NOT EXISTS ุฃููุงุน_ุงูุฅุฌุงุฒุงุช (
                ูุนุฑู INT AUTO_INCREMENT PRIMARY KEY,
                ุงุณู_ุงูุฅุฌุงุฒุฉ VARCHAR(100) NOT NULL,
                ุงููุตู TEXT,
                ุงูุญุงูุฉ ENUM('ููุนู', 'ุบูุฑ ููุนู') DEFAULT 'ููุนู'
            )
            """,
            """
            CREATE TABLE IF NOT EXISTS ุฃุฑุตุฏุฉ_ุงูุฅุฌุงุฒุงุช (
                ูุนุฑู INT AUTO_INCREMENT PRIMARY KEY,
                ูุนุฑู_ุงูููุธู INT NOT NULL,
                ุฑุตูุฏ_ุงูุณูุฉ_ุงูุญุงููุฉ INT DEFAULT 0,
                ุฑุตูุฏ_ุงูุนุงู_ุงูุณุงุจู_1 INT DEFAULT 0,
                ุฑุตูุฏ_ุงูุนุงู_ุงูุณุงุจู_2 INT DEFAULT 0,
                ุงูุณูุฉ INT NOT NULL,
                ุชุงุฑูุฎ_ุงูุชุญุฏูุซ TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
            """,
            """
            CREATE TABLE IF NOT EXISTS ุทูุจุงุช_ุงูุฅุฌุงุฒุฉ (
                ูุนุฑู INT AUTO_INCREMENT PRIMARY KEY,
                ูุนุฑู_ุงูููุธู INT NOT NULL,
                ููุน_ุงูุฅุฌุงุฒุฉ INT NOT NULL,
                ุชุงุฑูุฎ_ุงูุจุฏุก DATE NOT NULL,
                ุชุงุฑูุฎ_ุงูุงูุชูุงุก DATE NOT NULL,
                ุนุฏุฏ_ุงูุฃูุงู INT NOT NULL,
                ุงูุณุจุจ TEXT,
                ุงูุญุงูุฉ ENUM('ููุฏ ุงููุฑุงุฌุนุฉ', 'ูุนุชูุฏ', 'ูุฑููุถ', 'ููุบู') DEFAULT 'ููุฏ ุงููุฑุงุฌุนุฉ',
                ููุงุญุธุงุช_ุงููุฏูุฑ TEXT,
                ูุนุฑู_ุงููุฏูุฑ_ุงูููุงูู INT,
                ุชุงุฑูุฎ_ุงูุทูุจ TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
            """
        ]
        
        for ุฌุฏูู in ุฌุฏุงูู:
            cursor.execute(ุฌุฏูู)
        
        # ุฅุถุงูุฉ ุงููุณุชุฎุฏู ุงูุงูุชุฑุงุถู
        ูููุฉ_ูุฑูุฑ_ูุดูุฑุฉ = ุชุดููุฑ_ูููุฉ_ุงููุฑูุฑ('4856739')
        cursor.execute("""
            INSERT IGNORE INTO ุงููุณุชุฎุฏููู 
            (ุงุณู_ุงููุณุชุฎุฏู, ูููุฉ_ุงููุฑูุฑ, ุงุณู_ุงูููุธู, ููุน_ุงููุณุชุฎุฏู, ุงููุณู) 
            VALUES (%s, %s, %s, %s, %s)
        """, ('5485', ูููุฉ_ูุฑูุฑ_ูุดูุฑุฉ, 'ุงููุณุคูู ุงูุนุงู', 'ูุฏูุฑ_ุงููุธุงู', 'ุงูุฅุฏุงุฑุฉ ุงูุนุงูุฉ'))
        
        # ุฅุถุงูุฉ ุฃููุงุน ุงูุฅุฌุงุฒุงุช
        ุฃููุงุน_ุงูุฅุฌุงุฒุงุช = [
            ('ุฅุฌุงุฒุฉ ุงุนุชูุงุฏูุฉ', 'ุงูุฅุฌุงุฒุฉ ุงูุงุนุชูุงุฏูุฉ ุงูุณูููุฉ'),
            ('ุฅุฌุงุฒุฉ ุนุฑุถุฉ', 'ุฅุฌุงุฒุฉ ุงูุนุฑุถุฉ'),
            ('ุฅุฌุงุฒุฉ ุจุฏู ุฑุงุญุฉ', 'ุจุฏู ุงูุฑุงุญุฉ'),
            ('ุฅุฌุงุฒุฉ ุจุฏู ุนูู', 'ุจุฏู ุงูุนูู'),
            ('ุฅุฌุงุฒุฉ ุจุฏูู ูุฑุชุจ', 'ุฅุฌุงุฒุฉ ุจุฏูู ูุฑุชุจ'),
            ('ุฅุฌุงุฒุฉ ูุฑุถูุฉ', 'ุงูุฅุฌุงุฒุฉ ุงููุฑุถูุฉ'),
            ('ุฅุฌุงุฒุฉ ุทุงุฑุฆุฉ', 'ุงูุฅุฌุงุฒุฉ ุงูุทุงุฑุฆุฉ'),
            ('ุฅุฌุงุฒุฉ ุฏุฑุงุณูุฉ', 'ุงูุฅุฌุงุฒุฉ ุงูุฏุฑุงุณูุฉ'),
            ('ุฅุฌุงุฒุฉ ุญุฌ / ุนูุฑุฉ', 'ุฅุฌุงุฒุฉ ุงูุญุฌ ุฃู ุงูุนูุฑุฉ'),
            ('ุฅุฌุงุฒุฉ ูุฑุงููุฉ ูุฑูุถ', 'ุฅุฌุงุฒุฉ ูุฑุงููุฉ ุงููุฑูุถ')
        ]
        
        for ููุน_ุฅุฌุงุฒุฉ in ุฃููุงุน_ุงูุฅุฌุงุฒุงุช:
            cursor.execute("INSERT IGNORE INTO ุฃููุงุน_ุงูุฅุฌุงุฒุงุช (ุงุณู_ุงูุฅุฌุงุฒุฉ, ุงููุตู) VALUES (%s, %s)", ููุน_ุฅุฌุงุฒุฉ)
        
        connection.commit()
        cursor.close()
        connection.close()
        st.success("โ ุชู ุชููุฆุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุจูุฌุงุญ")
        
    except Exception as e:
        st.error(f"โ ุฎุทุฃ ูู ุชููุฆุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช: {e}")

# ุตูุญุฉ ุชุณุฌูู ุงูุฏุฎูู
def ุตูุญุฉ_ุชุณุฌูู_ุงูุฏุฎูู():
    st.markdown("<h1 style='text-align: center; color: #1f77b4;'>โ๏ธ ูุธุงู ุฅุฏุงุฑุฉ ุงูุฅุฌุงุฒุงุช - ุงููุทุงุฑ</h1>", unsafe_allow_html=True)
    
    col1, col2, col3 = st.columns([1, 2, 1])
    
    with col2:
        with st.form("ุชุณุฌูู ุงูุฏุฎูู"):
            st.subheader("ุชุณุฌูู ุงูุฏุฎูู")
            ุงุณู_ุงููุณุชุฎุฏู = st.text_input("ุงุณู ุงููุณุชุฎุฏู")
            ูููุฉ_ุงููุฑูุฑ = st.text_input("ูููุฉ ุงููุฑูุฑ", type="password")
            ุฒุฑ_ุงูุฏุฎูู = st.form_submit_button("๐ ุฏุฎูู ุฅูู ุงููุธุงู")
            
            if ุฒุฑ_ุงูุฏุฎูู:
                if ุงุณู_ุงููุณุชุฎุฏู and ูููุฉ_ุงููุฑูุฑ:
                    try:
                        connection = ุงูุญุตูู_ุนูู_ุงูุงุชุตุงู()
                        cursor = connection.cursor(dictionary=True)
                        cursor.execute("SELECT * FROM ุงููุณุชุฎุฏููู WHERE ุงุณู_ุงููุณุชุฎุฏู = %s AND ุงูุญุงูุฉ = 'ูุดุท'", (ุงุณู_ุงููุณุชุฎุฏู,))
                        ูุณุชุฎุฏู = cursor.fetchone()
                        
                        if ูุณุชุฎุฏู and ูุณุชุฎุฏู['ูููุฉ_ุงููุฑูุฑ'] == ุชุดููุฑ_ูููุฉ_ุงููุฑูุฑ(ูููุฉ_ุงููุฑูุฑ):
                            st.session_state.ูุนุฑู_ุงููุณุชุฎุฏู = ูุณุชุฎุฏู['ูุนุฑู']
                            st.session_state.ุงุณู_ุงููุณุชุฎุฏู = ูุณุชุฎุฏู['ุงุณู_ุงููุณุชุฎุฏู']
                            st.session_state.ุงุณู_ุงูููุธู = ูุณุชุฎุฏู['ุงุณู_ุงูููุธู']
                            st.session_state.ููุน_ุงููุณุชุฎุฏู = ูุณุชุฎุฏู['ููุน_ุงููุณุชุฎุฏู']
                            st.session_state.ุงููุณู = ูุณุชุฎุฏู['ุงููุณู']
                            st.success(f"โ ูุฑุญุจุงู {ูุณุชุฎุฏู['ุงุณู_ุงูููุธู']}!")
                            time.sleep(1)
                            st.rerun()
                        else:
                            st.error("โ ุงุณู ุงููุณุชุฎุฏู ุฃู ูููุฉ ุงููุฑูุฑ ุบูุฑ ุตุญูุญุฉ")
                    except Exception as e:
                        st.error(f"โ ุฎุทุฃ ูู ุงูุงุชุตุงู: {e}")
                else:
                    st.error("โ ูุฑุฌู ุฅุฏุฎุงู ุงุณู ุงููุณุชุฎุฏู ููููุฉ ุงููุฑูุฑ")
        
        st.markdown("---")
        st.info("""
        **ุงููุณุชุฎุฏู ุงูุงูุชุฑุงุถู ููุงุฎุชุจุงุฑ:**
        - **ุงุณู ุงููุณุชุฎุฏู:** 5485
        - **ูููุฉ ุงููุฑูุฑ:** 4856739
        """)

# ููุญุฉ ุชุญูู ุงูููุธู
def ููุญุฉ_ุงูููุธู():
    st.sidebar.title(f"ูุฑุญุจุงูุ {st.session_state.ุงุณู_ุงูููุธู}")
    st.sidebar.markdown(f"**ุงููุณู:** {st.session_state.ุงููุณู}")
    
    ูุงุฆูุฉ_ุงูููุธู = ["ุงูุฑุฆูุณูุฉ", "ุทูุจ ุฅุฌุงุฒุฉ ุฌุฏูุฏุฉ", "ุทูุจุงุชู", "ุฑุตูุฏ ุงูุฅุฌุงุฒุงุช", "ุงูุฅุดุนุงุฑุงุช"]
    ุงุฎุชูุงุฑ = st.sidebar.selectbox("ุงููุงุฆูุฉ", ูุงุฆูุฉ_ุงูููุธู)
    
    if ุงุฎุชูุงุฑ == "ุงูุฑุฆูุณูุฉ":
        ุงูุฑุฆูุณูุฉ_ุงูููุธู()
    elif ุงุฎุชูุงุฑ == "ุทูุจ ุฅุฌุงุฒุฉ ุฌุฏูุฏุฉ":
        ุทูุจ_ุฅุฌุงุฒุฉ_ุฌุฏูุฏุฉ()
    elif ุงุฎุชูุงุฑ == "ุทูุจุงุชู":
        ุนุฑุถ_ุทูุจุงุชู()
    elif ุงุฎุชูุงุฑ == "ุฑุตูุฏ ุงูุฅุฌุงุฒุงุช":
        ุนุฑุถ_ุฑุตูุฏ_ุงูุฅุฌุงุฒุงุช()

def ุงูุฑุฆูุณูุฉ_ุงูููุธู():
    st.title("๐ ููุญุฉ ุชุญูู ุงูููุธู")
    
    # ุฅุญุตุงุฆูุงุช ุณุฑูุนุฉ
    col1, col2, col3, col4 = st.columns(4)
    
    try:
        connection = ุงูุญุตูู_ุนูู_ุงูุงุชุตุงู()
        cursor = connection.cursor(dictionary=True)
        
        # ุนุฏุฏ ุงูุทูุจุงุช
        cursor.execute("""
            SELECT COUNT(*) as ุนุฏุฏ FROM ุทูุจุงุช_ุงูุฅุฌุงุฒุฉ 
            WHERE ูุนุฑู_ุงูููุธู = %s
        """, (st.session_state.ูุนุฑู_ุงููุณุชุฎุฏู,))
        ุนุฏุฏ_ุงูุทูุจุงุช = cursor.fetchone()['ุนุฏุฏ']
        
        # ุงูุทูุจุงุช ููุฏ ุงููุฑุงุฌุนุฉ
        cursor.execute("""
            SELECT COUNT(*) as ุนุฏุฏ FROM ุทูุจุงุช_ุงูุฅุฌุงุฒุฉ 
            WHERE ูุนุฑู_ุงูููุธู = %s AND ุงูุญุงูุฉ = 'ููุฏ ุงููุฑุงุฌุนุฉ'
        """, (st.session_state.ูุนุฑู_ุงููุณุชุฎุฏู,))
        ุทูุจุงุช_ูุนููุฉ = cursor.fetchone()['ุนุฏุฏ']
        
        # ุงูุฑุตูุฏ
        cursor.execute("""
            SELECT * FROM ุฃุฑุตุฏุฉ_ุงูุฅุฌุงุฒุงุช 
            WHERE ูุนุฑู_ุงูููุธู = %s ORDER BY ุงูุณูุฉ DESC LIMIT 1
        """, (st.session_state.ูุนุฑู_ุงููุณุชุฎุฏู,))
        ุฑุตูุฏ = cursor.fetchone()
        
        with col1:
            st.metric("ุฅุฌูุงูู ุงูุทูุจุงุช", ุนุฏุฏ_ุงูุทูุจุงุช)
        with col2:
            st.metric("ุทูุจุงุช ููุฏ ุงููุฑุงุฌุนุฉ", ุทูุจุงุช_ูุนููุฉ)
        with col3:
            if ุฑุตูุฏ:
                st.metric("ุฑุตูุฏ ุงูุณูุฉ ุงูุญุงููุฉ", ุฑุตูุฏ['ุฑุตูุฏ_ุงูุณูุฉ_ุงูุญุงููุฉ'])
            else:
                st.metric("ุฑุตูุฏ ุงูุณูุฉ ุงูุญุงููุฉ", 0)
        
        # ุขุฎุฑ ุงูุทูุจุงุช
        st.subheader("๐ ุขุฎุฑ ุทูุจุงุช ุงูุฅุฌุงุฒุฉ")
        cursor.execute("""
            SELECT ุท.*, ู.ุงุณู_ุงูุฅุฌุงุฒุฉ 
            FROM ุทูุจุงุช_ุงูุฅุฌุงุฒุฉ ุท 
            JOIN ุฃููุงุน_ุงูุฅุฌุงุฒุงุช ู ON ุท.ููุน_ุงูุฅุฌุงุฒุฉ = ู.ูุนุฑู 
            WHERE ุท.ูุนุฑู_ุงูููุธู = %s 
            ORDER BY ุท.ุชุงุฑูุฎ_ุงูุทูุจ DESC 
            LIMIT 10
        """, (st.session_state.ูุนุฑู_ุงููุณุชุฎุฏู,))
        ุทูุจุงุช = cursor.fetchall()
        
        if ุทูุจุงุช:
            ุจูุงูุงุช_ุงูุฌุฏูู = []
            for ุทูุจ in ุทูุจุงุช:
                ุจูุงูุงุช_ุงูุฌุฏูู.append({
                    "ููุน ุงูุฅุฌุงุฒุฉ": ุทูุจ['ุงุณู_ุงูุฅุฌุงุฒุฉ'],
                    "ูู": ุทูุจ['ุชุงุฑูุฎ_ุงูุจุฏุก'],
                    "ุฅูู": ุทูุจ['ุชุงุฑูุฎ_ุงูุงูุชูุงุก'],
                    "ุนุฏุฏ ุงูุฃูุงู": ุทูุจ['ุนุฏุฏ_ุงูุฃูุงู'],
                    "ุงูุญุงูุฉ": ุทูุจ['ุงูุญุงูุฉ'],
                    "ุชุงุฑูุฎ ุงูุทูุจ": ุทูุจ['ุชุงุฑูุฎ_ุงูุทูุจ']
                })
            
            st.dataframe(ุจูุงูุงุช_ุงูุฌุฏูู, use_container_width=True)
        else:
            st.info("ูุง ุชูุฌุฏ ุทูุจุงุช ุฅุฌุงุฒุฉ ุญุชู ุงูุขู")
            
    except Exception as e:
        st.error(f"ุฎุทุฃ ูู ุชุญููู ุงูุจูุงูุงุช: {e}")
    finally:
        cursor.close()
        connection.close()

def ุทูุจ_ุฅุฌุงุฒุฉ_ุฌุฏูุฏุฉ():
    st.title("๐ ุทูุจ ุฅุฌุงุฒุฉ ุฌุฏูุฏุฉ")
    
    try:
        connection = ุงูุญุตูู_ุนูู_ุงูุงุชุตุงู()
        cursor = connection.cursor(dictionary=True)
        
        # ุงูุญุตูู ุนูู ุฃููุงุน ุงูุฅุฌุงุฒุงุช
        cursor.execute("SELECT * FROM ุฃููุงุน_ุงูุฅุฌุงุฒุงุช WHERE ุงูุญุงูุฉ = 'ููุนู'")
        ุฃููุงุน_ุงูุฅุฌุงุฒุงุช = cursor.fetchall()
        
        # ุงูุญุตูู ุนูู ุงูุฑุตูุฏ
        cursor.execute("SELECT * FROM ุฃุฑุตุฏุฉ_ุงูุฅุฌุงุฒุงุช WHERE ูุนุฑู_ุงูููุธู = %s ORDER BY ุงูุณูุฉ DESC LIMIT 1", (st.session_state.ูุนุฑู_ุงููุณุชุฎุฏู,))
        ุฑุตูุฏ = cursor.fetchone()
        
        with st.form("ุทูุจ ุฅุฌุงุฒุฉ"):
            col1, col2 = st.columns(2)
            
            with col1:
                ููุน_ุงูุฅุฌุงุฒุฉ = st.selectbox("ููุน ุงูุฅุฌุงุฒุฉ", options=[ููุน['ูุนุฑู'] for ููุน in ุฃููุงุน_ุงูุฅุฌุงุฒุงุช], 
                                          format_func=lambda x: next((ููุน['ุงุณู_ุงูุฅุฌุงุฒุฉ'] for ููุน in ุฃููุงุน_ุงูุฅุฌุงุฒุงุช if ููุน['ูุนุฑู'] == x), ''))
                ุชุงุฑูุฎ_ุงูุจุฏุก = st.date_input("ุชุงุฑูุฎ ุงูุจุฏุก", min_value=datetime.now().date())
                ุงูุณุจุจ = st.text_area("ุณุจุจ ุงูุฅุฌุงุฒุฉ")
            
            with col2:
                # ุนุฑุถ ูุนูููุงุช ุงูุฑุตูุฏ
                if ุฑุตูุฏ:
                    st.info(f"""
                    **ุฑุตูุฏ ุงูุฅุฌุงุฒุงุช ุงููุชุงุญ:**
                    - ุงูุณูุฉ ุงูุญุงููุฉ: {ุฑุตูุฏ['ุฑุตูุฏ_ุงูุณูุฉ_ุงูุญุงููุฉ']} ููู
                    - ุงูุนุงู ุงูุณุงุจู 1: {ุฑุตูุฏ['ุฑุตูุฏ_ุงูุนุงู_ุงูุณุงุจู_1']} ููู
                    - ุงูุนุงู ุงูุณุงุจู 2: {ุฑุตูุฏ['ุฑุตูุฏ_ุงูุนุงู_ุงูุณุงุจู_2']} ููู
                    """)
                else:
                    st.warning("ูุง ููุฌุฏ ุฑุตูุฏ ุฅุฌุงุฒุงุช ูุชุงุญ")
                
                ุชุงุฑูุฎ_ุงูุงูุชูุงุก = st.date_input("ุชุงุฑูุฎ ุงูุงูุชูุงุก", min_value=datetime.now().date())
            
            if st.form_submit_button("ุชูุฏูู ุทูุจ ุงูุฅุฌุงุฒุฉ"):
                if ุชุงุฑูุฎ_ุงูุจุฏุก and ุชุงุฑูุฎ_ุงูุงูุชูุงุก:
                    if ุชุงุฑูุฎ_ุงูุงูุชูุงุก >= ุชุงุฑูุฎ_ุงูุจุฏุก:
                        ุนุฏุฏ_ุงูุฃูุงู = (ุชุงุฑูุฎ_ุงูุงูุชูุงุก - ุชุงุฑูุฎ_ุงูุจุฏุก).days + 1
                        
                        if ุฑุตูุฏ and ุฑุตูุฏ['ุฑุตูุฏ_ุงูุณูุฉ_ุงูุญุงููุฉ'] >= ุนุฏุฏ_ุงูุฃูุงู:
                            # ุฅุฏุฎุงู ุทูุจ ุงูุฅุฌุงุฒุฉ
                            cursor.execute("""
                                INSERT INTO ุทูุจุงุช_ุงูุฅุฌุงุฒุฉ 
                                (ูุนุฑู_ุงูููุธู, ููุน_ุงูุฅุฌุงุฒุฉ, ุชุงุฑูุฎ_ุงูุจุฏุก, ุชุงุฑูุฎ_ุงูุงูุชูุงุก, ุนุฏุฏ_ุงูุฃูุงู, ุงูุณุจุจ) 
                                VALUES (%s, %s, %s, %s, %s, %s)
                            """, (st.session_state.ูุนุฑู_ุงููุณุชุฎุฏู, ููุน_ุงูุฅุฌุงุฒุฉ, ุชุงุฑูุฎ_ุงูุจุฏุก, ุชุงุฑูุฎ_ุงูุงูุชูุงุก, ุนุฏุฏ_ุงูุฃูุงู, ุงูุณุจุจ))
                            
                            connection.commit()
                            st.success("โ ุชู ุชูุฏูู ุทูุจ ุงูุฅุฌุงุฒุฉ ุจูุฌุงุญ ูุณูุชู ูุฑุงุฌุนุชู ูุฑูุจุงู")
                        else:
                            st.error("โ ุฑุตูุฏ ุงูุฅุฌุงุฒุงุช ุบูุฑ ูุงู")
                    else:
                        st.error("โ ุชุงุฑูุฎ ุงูุงูุชูุงุก ูุฌุจ ุฃู ูููู ุจุนุฏ ุชุงุฑูุฎ ุงูุจุฏุก")
                else:
                    st.error("โ ูุฑุฌู ููุก ุฌููุน ุงูุญููู")
                    
    except Exception as e:
        st.error(f"ุฎุทุฃ: {e}")
    finally:
        cursor.close()
        connection.close()

def ุนุฑุถ_ุทูุจุงุชู():
    st.title("๐ ุทูุจุงุช ุงูุฅุฌุงุฒุฉ ุงูุฎุงุตุฉ ุจู")
    
    try:
        connection = ุงูุญุตูู_ุนูู_ุงูุงุชุตุงู()
        cursor = connection.cursor(dictionary=True)
        
        cursor.execute("""
            SELECT ุท.*, ู.ุงุณู_ุงูุฅุฌุงุฒุฉ 
            FROM ุทูุจุงุช_ุงูุฅุฌุงุฒุฉ ุท 
            JOIN ุฃููุงุน_ุงูุฅุฌุงุฒุงุช ู ON ุท.ููุน_ุงูุฅุฌุงุฒุฉ = ู.ูุนุฑู 
            WHERE ุท.ูุนุฑู_ุงูููุธู = %s 
            ORDER BY ุท.ุชุงุฑูุฎ_ุงูุทูุจ DESC
        """, (st.session_state.ูุนุฑู_ุงููุณุชุฎุฏู,))
        ุทูุจุงุช = cursor.fetchall()
        
        if ุทูุจุงุช:
            for ุทูุจ in ุทูุจุงุช:
                with st.expander(f"{ุทูุจ['ุงุณู_ุงูุฅุฌุงุฒุฉ']} - {ุทูุจ['ุชุงุฑูุฎ_ุงูุจุฏุก']} ุฅูู {ุทูุจ['ุชุงุฑูุฎ_ุงูุงูุชูุงุก']}"):
                    col1, col2, col3 = st.columns(3)
                    col1.metric("ุนุฏุฏ ุงูุฃูุงู", ุทูุจ['ุนุฏุฏ_ุงูุฃูุงู'])
                    col2.metric("ุงูุญุงูุฉ", ุทูุจ['ุงูุญุงูุฉ'])
                    col3.metric("ุชุงุฑูุฎ ุงูุทูุจ", ุทูุจ['ุชุงุฑูุฎ_ุงูุทูุจ'].strftime('%Y-%m-%d'))
                    
                    if ุทูุจ['ุงูุณุจุจ']:
                        st.write(f"**ุงูุณุจุจ:** {ุทูุจ['ุงูุณุจุจ']}")
                    if ุทูุจ['ููุงุญุธุงุช_ุงููุฏูุฑ']:
                        st.write(f"**ููุงุญุธุงุช ุงููุฏูุฑ:** {ุทูุจ['ููุงุญุธุงุช_ุงููุฏูุฑ']}")
        else:
            st.info("ูุง ุชูุฌุฏ ุทูุจุงุช ุฅุฌุงุฒุฉ")
            
    except Exception as e:
        st.error(f"ุฎุทุฃ ูู ุชุญููู ุงูุทูุจุงุช: {e}")
    finally:
        cursor.close()
        connection.close()

def ุนุฑุถ_ุฑุตูุฏ_ุงูุฅุฌุงุฒุงุช():
    st.title("๐ฐ ุฑุตูุฏ ุงูุฅุฌุงุฒุงุช")
    
    try:
        connection = ุงูุญุตูู_ุนูู_ุงูุงุชุตุงู()
        cursor = connection.cursor(dictionary=True)
        
        cursor.execute("""
            SELECT * FROM ุฃุฑุตุฏุฉ_ุงูุฅุฌุงุฒุงุช 
            WHERE ูุนุฑู_ุงูููุธู = %s ORDER BY ุงูุณูุฉ DESC
        """, (st.session_state.ูุนุฑู_ุงููุณุชุฎุฏู,))
        ุงูุฃุฑุตุฏุฉ = cursor.fetchall()
        
        if ุงูุฃุฑุตุฏุฉ:
            for ุฑุตูุฏ in ุงูุฃุฑุตุฏุฉ:
                st.subheader(f"ุณูุฉ {ุฑุตูุฏ['ุงูุณูุฉ']}")
                
                col1, col2, col3 = st.columns(3)
                col1.metric("ุฑุตูุฏ ุงูุณูุฉ ุงูุญุงููุฉ", ุฑุตูุฏ['ุฑุตูุฏ_ุงูุณูุฉ_ุงูุญุงููุฉ'])
                col2.metric("ุฑุตูุฏ ุงูุนุงู ุงูุณุงุจู 1", ุฑุตูุฏ['ุฑุตูุฏ_ุงูุนุงู_ุงูุณุงุจู_1'])
                col3.metric("ุฑุตูุฏ ุงูุนุงู ุงูุณุงุจู 2", ุฑุตูุฏ['ุฑุตูุฏ_ุงูุนุงู_ุงูุณุงุจู_2'])
                
                st.markdown("---")
        else:
            st.warning("ูุง ููุฌุฏ ุฑุตูุฏ ุฅุฌุงุฒุงุช ูุณุฌู")
            
    except Exception as e:
        st.error(f"ุฎุทุฃ ูู ุชุญููู ุงูุฃุฑุตุฏุฉ: {e}")
    finally:
        cursor.close()
        connection.close()

# ููุญุฉ ุชุญูู ูุฏูุฑ ุงููุธุงู
def ููุญุฉ_ูุฏูุฑ_ุงููุธุงู():
    st.sidebar.title(f"ูุฏูุฑ ุงููุธุงู - {st.session_state.ุงุณู_ุงูููุธู}")
    
    ูุงุฆูุฉ_ุงููุฏูุฑ = ["ุงูุฑุฆูุณูุฉ", "ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู", "ุงูุทูุจุงุช ุงููุนููุฉ", "ุงูุชูุงุฑูุฑ", "ุฅุฏุงุฑุฉ ุงูุฃุฑุตุฏุฉ"]
    ุงุฎุชูุงุฑ = st.sidebar.selectbox("ุงููุงุฆูุฉ", ูุงุฆูุฉ_ุงููุฏูุฑ)
    
    if ุงุฎุชูุงุฑ == "ุงูุฑุฆูุณูุฉ":
        ุงูุฑุฆูุณูุฉ_ูุฏูุฑ_ุงููุธุงู()
    elif ุงุฎุชูุงุฑ == "ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู":
        ุฅุฏุงุฑุฉ_ุงููุณุชุฎุฏููู()

def ุงูุฑุฆูุณูุฉ_ูุฏูุฑ_ุงููุธุงู():
    st.title("๐จโ๐ผ ููุญุฉ ุชุญูู ูุฏูุฑ ุงููุธุงู")
    
    try:
        connection = ุงูุญุตูู_ุนูู_ุงูุงุชุตุงู()
        cursor = connection.cursor(dictionary=True)
        
        # ุฅุญุตุงุฆูุงุช
        col1, col2, col3, col4 = st.columns(4)
        
        cursor.execute("SELECT COUNT(*) as ุนุฏุฏ FROM ุงููุณุชุฎุฏููู")
        ุนุฏุฏ_ุงูููุธููู = cursor.fetchone()['ุนุฏุฏ']
        
        cursor.execute("SELECT COUNT(*) as ุนุฏุฏ FROM ุทูุจุงุช_ุงูุฅุฌุงุฒุฉ WHERE ุงูุญุงูุฉ = 'ููุฏ ุงููุฑุงุฌุนุฉ'")
        ุทูุจุงุช_ูุนููุฉ = cursor.fetchone()['ุนุฏุฏ']
        
        cursor.execute("SELECT COUNT(*) as ุนุฏุฏ FROM ุทูุจุงุช_ุงูุฅุฌุงุฒุฉ WHERE ุงูุญุงูุฉ = 'ูุนุชูุฏ'")
        ุทูุจุงุช_ูุนุชูุฏุฉ = cursor.fetchone()['ุนุฏุฏ']
        
        with col1:
            st.metric("ุฅุฌูุงูู ุงูููุธููู", ุนุฏุฏ_ุงูููุธููู)
        with col2:
            st.metric("ุทูุจุงุช ููุฏ ุงููุฑุงุฌุนุฉ", ุทูุจุงุช_ูุนููุฉ)
        with col3:
            st.metric("ุทูุจุงุช ูุนุชูุฏุฉ", ุทูุจุงุช_ูุนุชูุฏุฉ)
        
        # ุฑุณู ุจูุงูู
        st.subheader("๐ ุฅุญุตุงุฆูุงุช ุงูุทูุจุงุช")
        cursor.execute("""
            SELECT ุงูุญุงูุฉ, COUNT(*) as ุงูุนุฏุฏ 
            FROM ุทูุจุงุช_ุงูุฅุฌุงุฒุฉ 
            GROUP BY ุงูุญุงูุฉ
        """)
        ุจูุงูุงุช = cursor.fetchall()
        
        if ุจูุงูุงุช:
            df = pd.DataFrame(ุจูุงูุงุช)
            fig = px.pie(df, values='ุงูุนุฏุฏ', names='ุงูุญุงูุฉ', title="ุชูุฒูุน ุทูุจุงุช ุงูุฅุฌุงุฒุฉ ุญุณุจ ุงูุญุงูุฉ")
            st.plotly_chart(fig)
            
    except Exception as e:
        st.error(f"ุฎุทุฃ ูู ุชุญููู ุงูุฅุญุตุงุฆูุงุช: {e}")
    finally:
        cursor.close()
        connection.close()

def ุฅุฏุงุฑุฉ_ุงููุณุชุฎุฏููู():
    st.title("๐ฅ ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู")
    
    try:
        connection = ุงูุญุตูู_ุนูู_ุงูุงุชุตุงู()
        cursor = connection.cursor(dictionary=True)
        
        # ุนุฑุถ ุงููุณุชุฎุฏููู ุงูุญุงูููู
        cursor.execute("""
            SELECT u.*, m.ุงุณู_ุงูููุธู as ุงุณู_ุงููุฏูุฑ 
            FROM ุงููุณุชุฎุฏููู u 
            LEFT JOIN ุงููุณุชุฎุฏููู m ON u.ุงููุฏูุฑ_ุงููุจุงุดุฑ = m.ูุนุฑู 
            ORDER BY u.ุชุงุฑูุฎ_ุงูุฅูุดุงุก DESC
        """)
        ุงููุณุชุฎุฏููู = cursor.fetchall()
        
        if ุงููุณุชุฎุฏููู:
            st.subheader("ุงููุณุชุฎุฏููู ุงูุญุงูููู")
            ุจูุงูุงุช_ุงูุฌุฏูู = []
            for ูุณุชุฎุฏู in ุงููุณุชุฎุฏููู:
                ุจูุงูุงุช_ุงูุฌุฏูู.append({
                    "ุงุณู ุงููุณุชุฎุฏู": ูุณุชุฎุฏู['ุงุณู_ุงููุณุชุฎุฏู'],
                    "ุงุณู ุงูููุธู": ูุณุชุฎุฏู['ุงุณู_ุงูููุธู'],
                    "ููุน ุงููุณุชุฎุฏู": ูุณุชุฎุฏู['ููุน_ุงููุณุชุฎุฏู'],
                    "ุงููุณู": ูุณุชุฎุฏู['ุงููุณู'],
                    "ุงูุญุงูุฉ": ูุณุชุฎุฏู['ุงูุญุงูุฉ']
                })
            
            st.dataframe(ุจูุงูุงุช_ุงูุฌุฏูู, use_container_width=True)
        
        # ุฅุถุงูุฉ ูุณุชุฎุฏู ุฌุฏูุฏ
        st.subheader("ุฅุถุงูุฉ ูุณุชุฎุฏู ุฌุฏูุฏ")
        with st.form("ุฅุถุงูุฉ ูุณุชุฎุฏู"):
            col1, col2 = st.columns(2)
            
            with col1:
                ุงุณู_ุงููุณุชุฎุฏู = st.text_input("ุงุณู ุงููุณุชุฎุฏู")
                ูููุฉ_ุงููุฑูุฑ = st.text_input("ูููุฉ ุงููุฑูุฑ", type="password")
                ุงุณู_ุงูููุธู = st.text_input("ุงุณู ุงูููุธู")
            
            with col2:
                ููุน_ุงููุณุชุฎุฏู = st.selectbox("ููุน ุงููุณุชุฎุฏู", ["ููุธู", "ูุฏูุฑ", "ูุณุคูู_ุฅุฏุงุฑู", "ูุฏูุฑ_ุงููุธุงู"])
                ุงููุณู = st.text_input("ุงููุณู")
            
            if st.form_submit_button("ุฅุถุงูุฉ ูุณุชุฎุฏู"):
                if ุงุณู_ุงููุณุชุฎุฏู and ูููุฉ_ุงููุฑูุฑ and ุงุณู_ุงูููุธู:
                    try:
                        ูููุฉ_ูุฑูุฑ_ูุดูุฑุฉ = ุชุดููุฑ_ูููุฉ_ุงููุฑูุฑ(ูููุฉ_ุงููุฑูุฑ)
                        cursor.execute("""
                            INSERT INTO ุงููุณุชุฎุฏููู 
                            (ุงุณู_ุงููุณุชุฎุฏู, ูููุฉ_ุงููุฑูุฑ, ุงุณู_ุงูููุธู, ููุน_ุงููุณุชุฎุฏู, ุงููุณู) 
                            VALUES (%s, %s, %s, %s, %s)
                        """, (ุงุณู_ุงููุณุชุฎุฏู, ูููุฉ_ูุฑูุฑ_ูุดูุฑุฉ, ุงุณู_ุงูููุธู, ููุน_ุงููุณุชุฎุฏู, ุงููุณู))
                        
                        connection.commit()
                        st.success("โ ุชู ุฅุถุงูุฉ ุงููุณุชุฎุฏู ุจูุฌุงุญ")
                        time.sleep(1)
                        st.rerun()
                    except Exception as e:
                        st.error(f"โ ุฎุทุฃ ูู ุฅุถุงูุฉ ุงููุณุชุฎุฏู: {e}")
                else:
                    st.error("โ ูุฑุฌู ููุก ุฌููุน ุงูุญููู ุงููุทููุจุฉ")
                    
    except Exception as e:
        st.error(f"ุฎุทุฃ ูู ุชุญููู ุงูุจูุงูุงุช: {e}")
    finally:
        cursor.close()
        connection.close()

# ุงูุชุทุจูู ุงูุฑุฆูุณู
def main():
    # ุชููุฆุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช
    ุชููุฆุฉ_ูุงุนุฏุฉ_ุงูุจูุงูุงุช()
    
    # ุงูุชุญูู ูู ุชุณุฌูู ุงูุฏุฎูู
    if 'ูุนุฑู_ุงููุณุชุฎุฏู' not in st.session_state:
        ุตูุญุฉ_ุชุณุฌูู_ุงูุฏุฎูู()
    else:
        # ุฅุถุงูุฉ ุฒุฑ ุชุณุฌูู ุงูุฎุฑูุฌ ูู ุงูุณุงูุฏุจุงุฑ
        with st.sidebar:
            if st.button("๐ช ุชุณุฌูู ุงูุฎุฑูุฌ"):
                for key in list(st.session_state.keys()):
                    del st.session_state[key]
                st.rerun()
        
        # ุชูุฌูู ุญุณุจ ููุน ุงููุณุชุฎุฏู
        if st.session_state.ููุน_ุงููุณุชุฎุฏู == 'ููุธู':
            ููุญุฉ_ุงูููุธู()
        elif st.session_state.ููุน_ุงููุณุชุฎุฏู == 'ูุฏูุฑ_ุงููุธุงู':
            ููุญุฉ_ูุฏูุฑ_ุงููุธุงู()
        else:
            st.warning("ููุญุฉ ุงูุชุญูู ููุฏ ุงูุชุทููุฑ ูููุน ุงููุณุชุฎุฏู ูุฐุง")

if __name__ == "__main__":
    main()
